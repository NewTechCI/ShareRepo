machine:
 pre:
  - rvm use 2.0.0
 ruby:
  version: ruby-2.0.0
 timezone:
    Asia/Tokyo
 services:
  - docker

dependencies:
 cache_directories:
  - "~/docker"
 pre:
 - docker info
    - if [[ -e ~/docker/image.tar ]]; then docker load --input ~/docker/image.tar; fi
    - docker build -t newtechci/docker-circleci .
    - mkdir -p ~/docker; docker save newtechci/docker-circleci > ~/docker/image.tar

  - bash ./bundle-install.sh
  - bash ./create-rspec-file.sh
 override:
  - docker info
  #- bash ./docker-build.sh

test:
  override:
   - docker run -d -p 80:8080 newtechci/docker-circleci
   - bash ./exec-serverspec.sh
